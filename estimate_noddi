
function[]=run(toolbox_path,data_dir,bval, bvec,DWI_data,brainmask_nii, brainmask_hdr)
%% adding toolboxes
NODDI_toolbox_dir=fullfile(toolbox_path, 'NODDI_toolbox_v1.01');
if ~exist(NODDI_toolbox_dir, 'dir')
    error('Could not find NODDI toolbox folder.');
end
niftimatlib_dir=fullfile(toolbox_path, 'niftimatlib-1.2');
if ~exist(niftimatlib_dir, 'dir')
    error('Could not find niftimatlib.');
end
addpath(genpath(NODDI_toolbox_dir));
addpath(genpath(niftimatlib_dir));
disp('Toolboxes was added successfully.');

%% selecting bvec file
bvec_dir=fullfile(data_dir,bvec);
fileID_bvec=fopen(bvec_dir,'r');
formatSpec = '%f %f %f';
sizeA = [3 inf];
bvec=fscanf(fileID_bvec, formatSpec, sizeA);
fclose(fileID_bvec);
fid = fopen('bvec.txt','wt');
for ii = 1:size(bvec,1)
    fprintf(fid,'%g\t',bvec(ii,:));
    fprintf(fid,'\n');
end
fclose(fid);
%% selecting bval file
bval_dir=fullfile(data_dir,bval);
fileID_bval=fopen(bval_dir);
formatSpec = '%f ';
sizeA = [1 inf];
bval=fscanf(fileID_bval, formatSpec, sizeA);
fclose(fileID_bval);
fid = fopen('bval.txt','wt');
for ii = 1:size(bval,1)
    fprintf(fid,'%g\t',bval(ii,:)*0.33);
    fprintf(fid,'\n');
end
fclose(fid);
%% converting the raw DWI volume into the required format
CreateROI(DWI_data, brainmask_nii, 'wholebrain.mat');
%% converting the FSL bval/bvec files into the required format
protocol = FSL2Protocol('bval.txt', 'bvec.txt');
%% create NODDI model structure 
noddi = MakeModel('WatsonSHStickTortIsoV_B0');
%% run the NODDI fitting
batch_fitting('wholebrain.mat', protocol, noddi, 'FittedParams.mat', 20);
SaveParamsAsNIfTI('FittedParams.mat', 'wholebrain.mat', brainmask_hdr, 'noddi')
end
